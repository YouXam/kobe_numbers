<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="kobe/24.png" type="image/png" />
    <title>Kobe Numbers</title>
    <script type="module" src="https://unpkg.com/@myriaddreamin/typst.ts/dist/esm/contrib/all-in-one-lite.bundle.js"
        id="typst"></script>
    <style>
        #content {
            width: 100%;
            top: 0;
            display: flex;
            margin: 100px 0px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #content .typst-doc {
            border-radius: 5px;
            border: 0.5px solid gray;
        }

        #input {
            font-size: 1em;
            font-family: monospace;
            resize: none;
            overflow: hidden;
            height: 7.5em;
            width: 80%;
            padding: 10px;
            border-radius: 5px;
            appearance: none;
            border: 1px solid gray;
            margin-top: 3px;
            margin-bottom: 5px;
        }

        #form {
            font-size: 1em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 100px;
        }

        input {
            font-size: 1em;
            font-family: monospace;
            resize: none;
            overflow: hidden;
            width: 5ch;
            padding: 5px;
            border-radius: 5px;
            appearance: none;
            margin: 0px 10px;
            border: 1px solid gray;
            margin: 3px 0px;
        }


        button {
            font-family: monospace;
            padding: 10px;
            border-radius: 5px;
            appearance: none;
            border: 1px solid gray;
            margin: 5px 0px;
            cursor: pointer;
            width: calc(80% + 20px);
            display: block;
        }
    </style>
</head>

<body>
    <div id="content">
        <div style="height: 305px; display: flex; flex-direction: column;justify-content: center; align-items: center; font-size: 2em;">
            <div>加载中...</div>
            <div style="font-size: 0.7em; margin-top: 20px;">首次加载可能需要较长时间</div>
        </div>
    </div>
    <div id="form">
        <div style="width: 80%">
            <a href="javascript:void()" id="example1">示例 1</a>
            <a href="javascript:void()" id="example2">示例 2</a>
        </div>
        <div style="width: 80%">
            <div>
                <code>#set page(height: auto, width: <input id="pagewidth"/>)</code>
            </div>
            <div>
                <code>#set text(size: <input id="textsize"/>)</code>
            </div>
            <div>
                <code>#set par(leading: <input id="parleading"/>)</code>
            </div>
        </div>
        <textarea id="input"></textarea>
        <button id="compile">生成</button>
        <button id="download">下载 png</button>
        <button id="downloadt">下载 png (透明背景)</button>
    </div>
    <footer style="text-align: center; margin-top: 100px;">
         <div>查看 <a href="https://typst.app/docs" target="_blank">Typst 文档</a> 以获取更多信息。</div>
        <div style="margin-top: 10px;">GitHub: <a href="https://github.com/YouXam/kobe_numbers"
                target="_blank">YouXam/kobe_numbers</a></div>
    </footer>
    <script>
        const rawFetch = fetch
        window.fetch = async function (url, options) {
            console.log(url)
            if (url.endsWith('.wasm') || url.endsWith('.ttf')) {
                const cache = await caches.open('typst');
                const cached = await cache.match(url);
                if (cached) {
                    console.log(url)
                    return cached;
                }
                const response = await rawFetch(url, options);
                if (response.ok) {
                    cache.put(url, response.clone());
                }
                return response
            }
            return rawFetch(url, options)
        }

        const input = document.getElementById('input');
        function autoResize() {
            input.style.height = 'auto';
            input.style.height = Math.max(input.scrollHeight, 142) + 'px';
        }
        autoResize()
        input.addEventListener('input', autoResize);
        input.value = '#set align(center)\n42 // 修改此处数字然后点击“生成”按钮';
        document.getElementById('pagewidth').value = '30cm';
        document.getElementById('textsize').value = '4em';
        document.getElementById('parleading').value = '4em';
        document.getElementById('typst').addEventListener('load', async function () {
            const examples = {
                'example1': {
                    'pagewidth': '30cm',
                    'textsize': '4em',
                    'parleading': '4em',
                    'content': '#set align(center)\n42 // 修改此处数字然后点击“生成”按钮'
                },
                'example2': {
                    'pagewidth': '20cm',
                    'textsize': '1em',
                    'parleading': '3em',
                    'content': '#set par(justify: true)\n你的素养很差，我现在每天玩原神都能赚150原石，每个月差不多5000原石的收入， 也就是现实生活中每个月5000美元的收入水平，换算过来最少也30000人民币，虽然我只有14岁，但是已经超越了中国绝大多数人(包括你)的水平，这便是原神给我的骄傲的资本。'
                }
            }

            for (const [id, example] of Object.entries(examples)) {
                document.getElementById(id).onclick = () => {
                    document.getElementById('pagewidth').value = example.pagewidth;
                    document.getElementById('textsize').value = example.textsize;
                    document.getElementById('parleading').value = example.parleading;
                    input.value = example.content;
                    autoResize();
                    compile(input.value);
                }
            }

            const templateReq = await fetch('kobe_numbers.typ')
            const template = (await templateReq.text())
                .replaceAll(`H("kobe`, `H("/kobe`);

            const cm = window.TypstCompileModule;
            
            const fetchBackend = new cm.FetchAccessModel(location.pathname);
            $typst.use(TypstSnippet.withAccessModel(fetchBackend));
            $typst.setCompilerInitOptions({
                beforeBuild: [
                    cm.preloadRemoteFonts([
                        "font.otf"
                    ])
                ],
                getModule: () =>
                    'https://unpkg.com/@myriaddreamin/typst-ts-web-compiler/pkg/typst_ts_web_compiler_bg.wasm',
            });
            $typst.setRendererInitOptions({
                getModule: () =>
                    'https://unpkg.com/@myriaddreamin/typst-ts-renderer/pkg/typst_ts_renderer_bg.wasm',
            });
            const compile = function (mainContent) {
                const pageWidth = document.getElementById('pagewidth').value;
                const textSize = document.getElementById('textsize').value;
                const parLeading = document.getElementById('parleading').value;
                $typst.svg({
                    mainContent: template + `\n\n#show: kobe_numbers
                    #set page(height: auto, width: ${pageWidth}, margin: 1in)
                    #set par(leading: ${parLeading})
                    #set text(size: ${textSize}, font: ("123asd", ))
                    ` + mainContent
                }).then(svg => {
                    document.getElementById('content').innerHTML = svg;
                });
            };
            function download(transparent) {
                const svgElement = document.querySelector('svg');
                const svg = (new XMLSerializer).serializeToString(svgElement);

                const originalWidth = svgElement.width.baseVal.value;
                const originalHeight = svgElement.height.baseVal.value;
    
                let scale = Math.min(10, Math.floor(Math.sqrt(16777216 / (originalWidth * originalHeight))));
                const canvasWidth = svgElement.width.baseVal.value * scale;
                const canvasHeight = svgElement.height.baseVal.value * scale;

                const canvas = document.createElement('canvas');
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                const ctx = canvas.getContext('2d');
                if (!transparent) {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                }

                const img = new Image();
                img.onload = function () {
                    ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob, { type: 'image/png' });
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'kobe_numbers.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                };
                img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
            }
            document.getElementById('download').onclick = () => {
                download(false);
            }
            document.getElementById('downloadt').onclick = () => {
                download(true);
            }
            document.getElementById('compile').onclick = () => compile(input.value);
            compile(input.value);
        });
    </script>
</body>

</html>
